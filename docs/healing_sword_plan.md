# Healing Sword — План реализации (Fabric 1.19.2)

## 0. Базовая архитектура проекта

**Технологический стек**
- Minecraft 1.19.2 + Fabric Loader.
- Fabric API, Mixin.
- (Опционально) Cardinal Components API или Fabric Data API для компонентов предметов.
- (Опционально) Cloth Config для конфигурации и GeckoLib для расширенной анимации.

**Пакетная структура**
```
com.yourmod.healingsword
├── registry        // регистрация предметов, эффектов, частиц, звуков, рецептов
├── item            // логика мечей по стадиям, общий базовый класс
├── component       // компоненты стека (энергия, опыт, стадия, флаги морального дрейфа)
├── ability         // активные/пассивные способности, ауры, очистка, взрывы
├── network         // пакеты синхронизации (S2C/C2S)
├── util            // утилиты (NBT, математика, поиск целей, таймеры)
├── config          // конфигурация, JSON5-файлы, автоконфиг
├── data            // генерация данных (рецепты, теги, лут-таблицы)
└── client
    ├── particle    // клиентские частицы и их фабрики
    ├── render      // рендеры предметов, HUD-индикация
    └── sound       // управление звуками и аудиоклипами
```

**Данные и конфиги**
- Все коэффициенты баланса (урон, лечение, радиусы, стоимость энергии) вынести в JSON5-конфиг, поддерживаемый Cloth Config или аналогом.
- Рецепты апгрейдов стадий — в datapack (`data/yourmod/recipes/...`).
- Advancements для тестирования и отслеживания прогресса игрока.

**Состояние меча**
- `ItemStack` NBT/Component: `stage:int`, `energy:int`, `kills:int`, `unstable:float`, `cooldowns:{...}`.
- Клиентская синхронизация только при изменении визуально значимых параметров (HUD, частицы).

**События/хуки (Fabric)**
- `AttackEntityCallback` — расчёт вампиризма, накопление энергии, запуск аур.
- `UseItemCallback` / переопределения `Item#use` — активируемые способности (ауры, очистка, взрывы).
- `ServerTickEvents.END_WORLD_TICK` — периодическое обновление аур, троттлинг до 1 раза в 10 тиков.
- Логика наложения эффектов через `StatusEffect` и обработку событий смерти сущностей.

**Оптимизация**
- Ауры обновляются пачками (раз в 10–20 тиков) и используют `Box` + `World.getOtherEntities(...)` с предикатами.
- Минимизировать записи в NBT: накопление изменений и коммит по таймерам.
- Частицы спавнить с ограничением по дистанции и настраиваемыми уровнями качества.
- Серверные расчёты — на серверной стороне; клиент показывает только визуал.

## 1. Общие механики

1. **Вампиризм** — конверсия процента нанесённого урона в здоровье владельца (кап по тикам для предотвращения злоупотреблений).
2. **Энергосистема** — энергия накапливается от ударов и убийств, тратится на активные способности; лимиты зависят от стадии.
3. **Ауры и навыки** — временные эффекты в радиусе, зависящие от стадии и типа способности; требуют кулдауны и стоимость энергии.
4. **Прогрессия стадий** — апгрейд предмета через крафты и выполнение требований (уровень игрока, количество убийств, запас энергии).
5. **Моральный дрейф** — трекинг «свет»/«кровь» через флаги, влияющие на параметры меча и потенциальные ветки развития.
6. **Визуал и аудио** — частицы, свечение клинка, звуки ударов и активаций, HUD-индикатор энергии/стадии.

## 2. Стадии меча

### Стадия I — «Зачатие» (Меч Жизни)
- Вампиризм: 10% нанесённого урона, ограничение лечения раз в тик.
- Активных способностей нет; меч служит базой прогрессии.
- Энергосистема упрощённая: можно отключить или ограничить максимум низким потолком.
- Визуал: мягкое зелёное свечение, редкие зелёные частицы вокруг клинка.

### Стадия II — «Пробуждение» (Клинок Сердца)
- Вампиризм: 20%.
- Триггер ауры после критического удара: радиус 2 блока, длительность 5 секунд, эффект `Regeneration I` союзникам.
- Энергия: +1 единица за каждые 3 успешных удара.
- Визуал/аудио: холодное сияние, импульсы при крите, лёгкий звуковой отклик.

### Стадия III — «Расцвет» (Животворящий Клинок)
- Вампиризм: 30%.
- Активируемая аура исцеления: радиус 5 блоков, периодический тик (раз в 10 тиков) накладывает регенерацию союзникам.
- Бафф при убийстве: владельцу даётся `Regeneration` на 5 секунд.
- Энергия: расход 2 единицы за удар; убийство восполняет фиксированную величину.
- Визуал: пульсация зелёно-красных оттенков, более частые частицы.

### Стадия IV — «Вознесение» (Кровь и Свет)
- Вампиризм: 40%.
- Активная способность «Очистка»: снимает негативные эффекты с владельца, стоит 1 единицу здоровья и энергию.
- Иммунитет к яду и слепоте на 10 секунд после активации очистки.
- Аура очищения: радиус 7 блоков, мгновенный импульс эффектов.
- Визуал: алая и золотая аура, низкочастотный гул.

### Стадия V — «Падение» (Рассвет Бездны)
- Вампиризм: 50% наносимого урона конвертируется в случайный эффект: лечение или урон владельцу (по «нестабильности»).
- Активка «Взрыв жизненной энергии»: радиус 8 блоков, AoE-урон всем целям (включая владельца), союзники получают регенерацию.
- Энергия нестабильна: шанс «перегрузки души» 10%, вызывающий массовое лечение и урон владельцу.
- Визуал: хаотичная смесь света и тьмы, шёпот, опциональные экранные искажения.

## 3. Нефункциональные требования и балансировка

- Ввести ограничение максимального лечения в секунду, чтобы не ломать бой.
- Каждой активной способности назначить кулдауны и стоимость энергии.
- Добавить серверные гейм-правила для глобального включения/отключения механик и тонкой настройки параметров.
- Следить за совместимостью с ванильными эффектами и чарованиями (особенно `Sharpness`, `Smite`, `Looting`).

## 4. Поэтапный план (Спринты)

### Спринт A — Каркас и Стадия I
1. Настроить мод-инициализацию, зарегистрировать предмет, частицы, звуки.
2. Реализовать `HealingSwordItem` как базовый класс, подключить конфиг.
3. Внедрить вампиризм 10% на серверной стороне, базовую визуализацию.
4. Написать юнит-тесты для проверки конверсии урона и интеграционные сценарии PVE/PVP.

### Спринт B — Энергия и Стадия II
1. Добавить компонент энергии (через NBT или CCA) и HUD-индикатор.
2. Реализовать крит-триггер ауры (радиус 2, 5 секунд), оптимизировать частоту вызовов.
3. Создать рецепт апгрейда на стадию II и проверки требований (уровень, убийства).
4. Дополнить визуальные и аудиоэффекты критов.

### Спринт C — Аура III и бонусы за убийства
1. Реализовать активируемую ауру с радиусом 5, троттлинг обновления.
2. Подключить бафф при убийстве и учёт энергии (расход/восполнение).
3. Добавить эффективный поиск целей (Box + предикаты) и кеширование.
4. Обновить конфиг параметров и тесты (массовые сценарии).

### Спринт D — Очистка IV
1. Имплементировать активку очистки с затратами энергии и HP.
2. Ввести иммунитеты на таймере (отслеживание на владельце).
3. Добавить кастомные звуки, частицы, параметры в конфиг.
4. Провести балансные испытания и UX-тесты (HUD уведомления).

### Спринт E — Нестабильность V
1. Реализовать случайную конверсию урона (лечение/урон владельцу) с использованием тикового сида.
2. Сконструировать «Взрыв жизненной энергии» с дружественным огнём.
3. Добавить шанс перегрузки души, массовые эффекты и соответствующие визуалы.
4. Написать нагрузочные тесты для проверки производительности при множестве целей.

### Спринт F — Контент и полировка
1. Генерация datapack-ресурсов (рецепты, advancements, лут-таблицы), локализация (en_us, ru_ru).
2. Конфигурация серверных гейммодов и опций отключения механик.
3. Профилирование, регрессионные тесты, совместимость с популярными модами.
4. Финальная полировка HUD, подсказок, документации.

## 5. Структура кода и интерфейсы

- `HealingSwordItem` (extends `SwordItem`) — общий класс со ссылкой на `IStageBehavior`.
- `IStageBehavior` — интерфейс с методами `onHit`, `onUse`, `tickAura`, `getVampirismPct`, `getEnergyDelta`, `shouldTriggerCriticalAura` и др.
- Реализации `Stage1Behavior` … `Stage5Behavior` инкапсулируют логику каждой стадии.
- `EnergyComponent` — управление энергией, лимитами и синхронизацией.
- Абстракции для способностей: `Ability`, `AuraAbility`, `CleanseAbility`, `SoulBurstAbility`.
- `TargetingUtil` — поиск целей через `Box`, фильтры союзников/врагов, кеш по тикам.
- `ParticlesManager` и `SoundManager` — клиентская батч-генерация эффектов.
- `HealingSwordConfig` — структура конфигурации, сериализуемая в JSON5.
- `HealingSwordNetworking` — регистрирует каналы для синхронизации энергии, стадий и визуальных эффектов.

## 6. Оптимизация и производительность

- Ауры и способности обновляют состояние не чаще 1 раза в 10–20 тиков, адаптируются к текущему TPS.
- Поиск целей кеширует списки сущностей на 1–2 тика и ограничивает количество.
- Вести статистику (в dev-режиме) по количеству вызовов способностей, времени обработки и радиусам.
- Сеть: изменения состояния пакуются и отправляются партиями; синхронизация HUD только при пороговых изменениях.
- Частицы и звуки — с уровнями качества, возможность отключить на слабых клиентах.

## 7. Тест-план

- **Юнит-тесты:** проверка процента лечения, затрат энергии, соблюдения кулдаунов.
- **Интеграционные тесты:** бой против толпы мобов, PVP, взаимодействие с эффектами (зелья, тотемы).
- **Нагрузочные тесты:** 50+ сущностей в радиусе аур, профили TPS, стресс-тесты энергосистемы.
- **Тест сохранений:** перезаход в мир, перенос на сервер, проверка отсутствия дюпов.

## 8. Контент и UX

- HUD-колечко энергии и индикация стадии, всплывающие подсказки о кулдаунах.
- Подсказки (tooltips) с описанием активок и их стоимости.
- Advancements-«учебник» по стадиям и механикам.
- Полная локализация (en_us, ru_ru).

## 9. Дальнейшее расширение

- Ветвление «Путь Света/Крови» с альтернативными реализациями `IStageBehavior`.
- Синергии с другими модами через теги/капсулы (например, манапулы, души).
- Добавление кастомных зачарований, рун и дополнительных стадий.

Этот план обеспечивает чёткую модульную архитектуру, контролируемую балансировку, оптимизацию производительности и возможность расширения в будущих обновлениях.
